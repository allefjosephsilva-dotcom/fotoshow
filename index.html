<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Alef José (Fotoshow)</title>
  <style>
    /* Estilos originais mantidos */
    body{background:#0f0f12;color:#fff;font-family:sans-serif;margin:0;padding:0}
    .container{max-width:900px;margin:auto;padding:20px}
    .card{background:#1a1a1f;padding:20px;border-radius:12px;margin-bottom:20px}
    .input,select{width:100%;padding:10px;border-radius:8px;border:1px solid #333;background:#222;color:#fff;margin-bottom:10px}
    .btn{padding:10px 14px;border:none;border-radius:8px;background:#6c63ff;color:#fff;cursor:pointer}
    .btn:hover{background:#5751d9}
    .dropzone{padding:20px;border:2px dashed #444;text-align:center;border-radius:8px;margin-bottom:10px}
  </style>
</head>
<body>
  <div class="container">
    <h1>Painel do Dono - Upload</h1>
    <div class="card">
      <h3>Upload de Fotos</h3>
      <label>Escolha o álbum:</label>
      <select id="uploadAlbum"></select>
      
      <div class="dropzone" id="dropzone">Solte arquivos aqui ou clique para selecionar</div>
      <input type="file" id="fileInput" accept="image/*" multiple hidden />

      <h4>Ou envie por URL</h4>
      <input type="text" id="urlInput" class="input" placeholder="Cole a URL direta da imagem aqui" />
      <button class="btn" id="addUrlBtn">Adicionar pela URL</button>
      
      <p style="font-size:12px;color:#aaa">As fotos são salvas localmente no IndexedDB do navegador.</p>
    </div>

    <div id="photosGrid" class="container" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px"></div>
  </div>

  <script>
    const DB_NAME = 'PhotoSiteDB';
    const DB_STORE = 'photos';

    function openDB(){
      return new Promise((resolve,reject)=>{
        const req = indexedDB.open(DB_NAME,1);
        req.onupgradeneeded = ()=>{
          const db = req.result;
          if(!db.objectStoreNames.contains(DB_STORE)){
            db.createObjectStore(DB_STORE,{keyPath:'id'});
          }
        };
        req.onsuccess = ()=>resolve(req.result);
        req.onerror = ()=>reject(req.error);
      });
    }

    async function idbPut(record){
      const db = await openDB();
      return new Promise((resolve,reject)=>{
        const tx = db.transaction(DB_STORE,'readwrite');
        tx.objectStore(DB_STORE).put(record);
        tx.oncomplete = ()=>resolve();
        tx.onerror = ()=>reject(tx.error);
      });
    }

    const state = {albums:{},photos:{}};

    function uid(){return 'id_'+Math.random().toString(36).slice(2)+Date.now().toString(36)}

    const uploadAlbum = document.getElementById('uploadAlbum');
    const photosGrid = document.getElementById('photosGrid');

    // Carregar albuns de exemplo
    function loadAlbums(){
      if(Object.keys(state.albums).length===0){
        const id = uid();
        state.albums[id] = {id,name:'Geral'};
      }
      uploadAlbum.innerHTML = '';
      Object.values(state.albums).forEach(alb=>{
        const opt = document.createElement('option');
        opt.value = alb.id;
        opt.textContent = alb.name;
        uploadAlbum.appendChild(opt);
      });
    }

    loadAlbums();

    // Função para salvar fotos enviadas por URL
    document.getElementById('addUrlBtn').addEventListener('click', async()=>{
      const url = document.getElementById('urlInput').value.trim();
      const alb = uploadAlbum.value;
      if(!url) return alert('Informe a URL da imagem.');
      try{
        const resp = await fetch(url);
        if(!resp.ok) throw new Error('Erro ao baixar imagem.');
        const blob = await resp.blob();
        const id = uid();
        await idbPut({id,albumId:alb,blob,type:blob.type,createdAt:Date.now()});
        state.photos[id] = {albumId:alb,createdAt:Date.now()};
        renderPhotos();
        document.getElementById('urlInput').value = '';
        alert('Foto adicionada com sucesso!');
      }catch(e){
        alert('Erro ao adicionar foto: '+e.message);
      }
    });

    // Upload tradicional
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput');
    dropzone.addEventListener('click',()=>fileInput.click());
    fileInput.addEventListener('change',e=>handleFiles(e.target.files));
    dropzone.addEventListener('dragover',e=>{e.preventDefault();dropzone.style.borderColor='#666'});
    dropzone.addEventListener('dragleave',()=>dropzone.style.borderColor='#444');
    dropzone.addEventListener('drop',e=>{e.preventDefault();handleFiles(e.dataTransfer.files)});

    async function handleFiles(files){
      const alb = uploadAlbum.value;
      for(const file of files){
        if(!file.type.startsWith('image/')) continue;
        const id = uid();
        const buf = await file.arrayBuffer();
        await idbPut({id,albumId:alb,blob:new Blob([buf]),type:file.type,createdAt:Date.now()});
        state.photos[id] = {albumId:alb,createdAt:Date.now()};
      }
      renderPhotos();
    }

    // Renderizar fotos
    async function renderPhotos(){
      photosGrid.innerHTML = '';
      const db = await openDB();
      const tx = db.transaction(DB_STORE,'readonly');
      const store = tx.objectStore(DB_STORE);
      const req = store.getAll();
      req.onsuccess = ()=>{
        req.result.forEach(rec=>{
          const url = URL.createObjectURL(rec.blob);
          const img = document.createElement('img');
          img.src = url;
          img.style.width = '100%';
          img.style.borderRadius = '8px';
          photosGrid.appendChild(img);
        });
      };
    }

    renderPhotos();
  </script>
</body>
</html>
